<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Schleedener Thekenrechner</title>
  <style>
    :root{
      --page-max: 100vw;
      --radius: 12px;
      --shadow: 0 2px 10px rgba(0,0,0,.12);
      --tile-border: 6px;
      --gap: 12px;
    }

    *{ box-sizing: border-box; }
    html, body{
      margin:0; padding:0; height:100%;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:#f5f5f7; color:#111;
    }

    /* Bessere Lesbarkeit auf allen Displays */
    body{ font-size: clamp(15px, 1.6vw, 18px); line-height:1.35; }

    /* Haupt-Container */
    .main-content{
      margin:0 auto; max-width: var(--page-max);
      padding: 12px 16px 80px; /* Platz unten; wird via JS erweitert */
    }

    /* Grid für Kacheln – passt sich flexibel an */
    .drink-container{
      display:grid; gap: var(--gap);
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
    }
    @media (max-width: 900px){
      .drink-container{ grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
    }
    @media (max-width: 560px){
      .drink-container{ grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
    }

    /* Kacheln (Touch‑freundlich) */
    .drink-tile{
      position:relative; border-radius: var(--radius);
      padding: 10px; text-align:center; user-select:none; cursor:pointer;
      transition: background-color .25s ease, box-shadow .25s ease, border-color .25s ease;
      box-shadow: var(--shadow); border: var(--tile-border) solid #d9d9de; background:#fff;
      touch-action: manipulation; /* schnelles Click-Verhalten auf Mobilgeräten */
    }
    .drink-tile:focus-visible{ outline: 3px solid #2563eb; outline-offset: 2px; }

    .drink-tile h2{ margin:.25em 0 .35em; font-size: clamp(1rem, 2.8vw, 1.25rem); }

    .drink-tile img{
      max-width: 120px; max-height: 100%; height:auto; display:block; margin: 0 auto 6px;
      object-fit: contain; border-radius: 8px;
    }

    /* Menge/Preis */
    .quantity-display{ font-weight:700; margin:.35em 0; font-size: clamp(1rem, 3.2vw, 1.2rem); }
    .price{ margin:.15em 0; font-size: .95em; color:#333; }

    .quantity-controls{ display:flex; align-items:center; justify-content:center; gap:8px; margin-top:6px; flex-wrap:wrap; }
    .quantity-controls button{
      font-size: clamp(1rem, 3.6vw, 1.15rem);
      padding: 10px 14px; border-radius: 10px; border:1px solid #8a8a8a; background:#fafafa; cursor:pointer;
      min-width: 48px; min-height: 44px; touch-action: manipulation;
    }
    .quantity-controls button:active{ transform: translateY(1px); }

    /* Aktive Kachel bekommt farbigen Hintergrund */
    .drink-tile.active{ box-shadow: 0 3px 14px rgba(0,0,0,.18); }

    /* Add-ons */
    .addons-container{ margin-top:8px; border-top:1px solid #cfcfd4; padding-top:8px; display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:6px; }
    .addon-tile{ display:block; width:100%; border:2px solid #999; border-radius: 10px; padding:6px 8px; margin:0; text-align:center; cursor:pointer; background:#fff; transition: background-color .25s ease; min-width:auto; word-break: break-word; }
    .addon-tile h3{ margin:0 0 2px; font-size:.95em; }
    .addon-tile p{ margin:0; font-size:.85em; }
    .addon-controls{ display:grid; grid-template-columns: repeat(auto-fit, minmax(44px, 1fr)); gap:6px; justify-content:stretch; align-items:stretch; margin-top:6px; }
    .addon-controls button{ width:100%; min-width:0; min-height:44px; padding:8px 10px; border-radius:10px; border:1px solid #8a8a8a; background:#fafafa; font-size:1rem; cursor:pointer; }

    /* Zusammenfassung als Bottom‑Sheet */
    .summary{
      position: fixed; left: 50%; bottom: 0; transform: translateX(-50%);
      width: 100%; max-width: var(--page-max); background:#fff; border-top:1px solid #ccc; box-shadow: 0 -6px 20px rgba(0,0,0,.18);
      max-height: 60vh; overflow: hidden; border-top-left-radius: 14px; border-top-right-radius: 14px;
      padding-bottom: env(safe-area-inset-bottom);
      display:flex; flex-direction:column;
    }

    .summary-header{
      display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 16px; position:sticky; top:0; background:#fff; z-index:3; border-bottom:1px solid #eee; order:0; margin:0;
    }
    .summary-title{ display:flex; align-items:center; gap:8px; font-weight:700; }
    .summary-toggle{
      display:flex; align-items:center; justify-content:space-between; gap:10px; width:100%;
      background:transparent; border:0; padding:8px 0; cursor:pointer; font: inherit; text-align:left;
    }
    .summary-toggle .chevron{ transition: transform .2s ease; }
    .summary.collapsed .summary-toggle .chevron{ transform: rotate(-90deg); }

    .summary-content{ padding: 10px 16px; overflow-y:auto; max-height: 50vh; order:1; }
    .summary.collapsed .summary-content{ display:none; }

    .summary-items{ border:1px solid #ddd; border-radius: 10px; background:#fff; overflow:auto; margin-bottom:10px; }
    .summary-table{ width:100%; border-collapse: collapse; font-size: .95em; }
    .summary-table th, .summary-table td{ text-align:left; padding:6px 8px; border-bottom:1px solid #eee; }
    .summary-table th{ background:#fafafa; position:sticky; top:0; z-index:1; }

    .summary-row{ display:flex; justify-content:space-between; gap:10px; margin-bottom:8px; }
    #grandTotal{ font-size: clamp(1.25rem, 4vw, 2rem); font-weight:800; }
    #grandTotalMini{ font-weight:700; }

    .cash-input{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin:6px 0; }
    .cash-input input{ width: 140px; font-size: 1.05em; padding: 8px 10px; border-radius: 10px; border:1px solid #bbb; }

    .change-container{ display:flex; justify-content:flex-end; margin: 8px 0; }
    .change-display{ font-weight:800; font-size: clamp(1.25rem, 4vw, 2rem); }

    .reset-all-btn{ padding: 12px 16px; cursor:pointer; border-radius: 12px; border:1px solid #7b7b7b; background:#d7fbd4; width:100%; font-size:1.05em; }

    /* Mobile: Bottom‑Sheet standardmäßig eingeklappt */
    @media (max-width: 640px){
      .summary{ max-height: 70vh; }
    }

    /* Bewegungen für Menschen mit eingeschränkter Bewegungseinstellung reduzieren */
    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; scroll-behavior: auto !important; }
    }
    /* Tablet: volle Breite ausnutzen */
    @media (min-width: 640px) and (max-width: 1100px){
      :root{ --page-max: 100vw; }
      .main-content, .summary{ max-width: 100vw; }
      .summary{ border-top-left-radius: 0; border-top-right-radius: 0; }
    }
    /* Desktop: volle Breite */
    @media (min-width: 1100px){
      :root{ --page-max: 100vw; }
      .main-content, .summary{ max-width: 100vw; }
    }

    /* Kategorien-Leiste */
    .category-bar{ position:sticky; top:0; z-index:3; background:#f5f5f7; padding:8px 0; display:flex; gap:8px; flex-wrap:wrap; row-gap:8px; }
    .category-btn{ border:1px solid #ccc; background:#fff; padding:8px 12px; border-radius:9999px; cursor:pointer; font-size:1rem; }
    .category-btn[aria-pressed="true"]{ background:#111; color:#fff; border-color:#111; }
    /* Einheitlicher Startpunkt für Text: fixer Bildbereich */
    .tile-media{ height: 96px; display:flex; align-items:center; justify-content:center; }
    .drink-tile{ overflow: hidden; }
    .summary-header{ gap:10px; }
    
    
    /* Nur der Toggle im Header darf sichtbar sein */
    .summary .summary-toggle{ display:none; }
    .summary > .summary-header .summary-toggle{ display:flex; }
    /* Verhindere duplizierte Mini-Summe außerhalb des Headers */
    #grandTotalMini{ display:none; } /* hide duplicates */
    /* Entferne ggf. untere Geisterleiste */
    .summary > .summary-content > .summary-toggle, .summary > .summary-content > #grandTotalMini{ display:none !important; }
    .summary-header #grandTotalMini{ display:inline; }
    /* Kleinere, einzeilige Hinweis-Label im Header */
    .summary-title{ white-space: nowrap; min-width:0; }
    .summary-hint{ opacity:.6; font-size:.85em; white-space:nowrap; }
    @media (max-width: 600px){ .summary-hint{ font-size:.75em; } }
    /* Zeilen in der Übersicht sind klickbar */
    .summary-table tbody tr{ cursor: pointer; }
    /* Größeres Häkchen + blaue Markierung bei gesetzter Zeile */
    .summary-table td:first-child{ width: 48px; }
    .summary-table td:first-child input[type="checkbox"]{
      transform: scale(1.35);
      transform-origin: center;
      width: 18px; height: 18px;
      accent-color: #2563eb; /* Blau */
    }
    .summary-table tbody tr.row-checked{ box-shadow: inset 0 0 0 3px #2563eb; }
    /* --- Kompaktmodus & Zähler-Badge --- */
    .quantity-badge{ position:absolute; top:6px; right:6px; z-index:1; display:none; align-items:center; justify-content:center; min-width: clamp(30px, 7vw, 44px); height: clamp(30px, 7vw, 44px); padding: 0 10px; border-radius:9999px; font-weight:800; font-size: clamp(1rem, 3.6vw, 1.35rem); line-height:1; box-shadow: 0 1px 4px rgba(0,0,0,.25); }
    .density-toggle{ margin-left:auto; }
    @media (max-width:480px){ .density-toggle{ font-size:.9em; padding:6px 10px; } }

    body.compact .drink-container{ grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
    @media (max-width: 560px){ body.compact .drink-container{ grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); } }
    body.compact .drink-tile{ padding:8px; border-width:4px; }
    body.compact .tile-media{ height:64px; }
    body.compact .price{ font-size:.85em; }
    body.compact .quantity-display{ display:none; }
    body.compact .quantity-controls button{ min-width:40px; min-height:40px; padding:6px 8px; font-size:.95em; }
    /* Mobile: Kategorienzeile immer einzeilig, horizontal scrollen statt Umbruch */
    @media (max-width: 640px){
      .category-bar{ flex-wrap: nowrap; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-gutter: stable both-edges; }
      .category-btn{ flex: 0 0 auto; }
      .density-toggle{ margin-left: 8px; }
      .category-bar{ overscroll-behavior-x: contain; }
    }
    /* Sicherstellen: Übersicht liegt über Kacheln/Badges */
    .summary{ z-index: 1000; }
    .quantity-badge{ z-index: 0; }
  </style>
</head>
<body>

  <div class="main-content" id="mainContent">
    <div class="category-bar" id="categoryBar"></div>
    <div class="drink-container" id="drinkContainer"></div>
  </div>

  <div class="summary" id="summarySection" aria-live="polite">
  <div class="summary" id="summarySection" aria-live="polite">
    <div class="summary-header">
      <button id="summaryToggle" class="summary-toggle" aria-expanded="true" aria-controls="summaryContent">
        <div class="summary-title">Übersicht <span class="summary-hint">(Tippen zum Ein-/Ausklappen)</span></div>
        <div><span id="grandTotalMini">0,00 €</span> <span class="chevron">▾</span></div>
      </button>
      
    </div>
        <div><span id="grandTotalMini">0,00 €</span> <span class="chevron">▾</span></div>
      </button>
    </div>

    <div class="summary-content" id="summaryContent" style="display:block;">
      <div class="summary-content" id="summaryContent">
      <div class="summary-items" id="summaryList"></div>

      <div class="change-container">
        <div class="change-display" id="grandTotal"></div>
      </div>

      <div class="cash-input">
        <label for="cashGiven">Betrag gegeben</label>
        <input type="number" id="cashGiven" step="0.01" inputmode="decimal" placeholder="0,00" />
        <span>€</span>
      </div>

      <div class="change-container">
        <div class="change-display" id="changeDisplay"></div>
      </div></div>
  </div>

  <script>
  /* Daten (unverändert) */
  let drinks = [
    { name: "Pils", price: 2.50, quantity: 0, color: "#FFF4B1", imgUrl: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS9JBs4nm5Z63O_KefzY-VdjKM7Eii-igv0FQ&s", addOns: [] },
    { name: "Kölsch", price: 2.50, quantity: 0, color: "#D4FFB2", imgUrl: "https://cdn02.plentymarkets.com/99cbvkn2wswt/item/images/580/full/Reissdorf-Koelsch-0-33-l-Bierflasche-kaufen.jpg", addOns: [] },
    { name: "Fassbrause Zitrone", price: 2.50, quantity: 0, color: "#FFFBC0", imgUrl: "https://www.mrspeedy.de/cdn/shop/products/20345659_digital-image.webp?v=1664024806", addOns: [] },
    { name: "Cola", price: 2.50, quantity: 0, color: "#FFDAD4", imgUrl: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/ce/Coca-Cola_logo.svg/2560px-Coca-Cola_logo.svg.png", addOns: [] },
    { name: "Cola Zero", price: 2.50, quantity: 0, color: "#E8D6FF", imgUrl: "https://upload.wikimedia.org/wikipedia/commons/9/93/Coca_Cola-zero_Logo_300dpi.jpg", addOns: [] },
    { name: "Limo", price: 2.50, quantity: 0, color: "#FFEAB0", imgUrl: "https://www.sucosorder.com/media/images/org/Fanta.jpg", addOns: [] },
    { name: "Sprite", price: 2.50, quantity: 0, color: "#D4F8FF", imgUrl: "https://upload.wikimedia.org/wikipedia/commons/a/ae/Sprite_2022.svg", addOns: [] },
    { name: "Apfelschorle", price: 2.50, quantity: 0, color: "#FFEFD0", imgUrl: "https://ebbingshop.de/64-large_default/lift-apfelschorle-05l.jpg", addOns: [] },
    { name: "Wasser", price: 2.50, quantity: 0, color: "#CCE7FF", imgUrl: "https://cdn.metro-group.com/de/de_pim_459260002002_02.png?w=400&h=400&mode=pad", addOns: [] },
    { name: "Pils 0,0 %", price: 2.50, quantity: 0, color: "#FFDEFC", imgUrl: "https://onlinedurst.de/media/image/d4/f4/a2/43563_bitb_pils_033l_72dpi_rgb.jpg", addOns: [] },
    { name: "Kölsch 0,0 %", price: 2.50, quantity: 0, color: "#D8FFD8", imgUrl: "https://img.rewe-static.de/3274667/38179040_digital-image.png", addOns: [] },
    { name: "Capri-Sun", price: 0.50, quantity: 0, color: "#FFD1FF", imgUrl: "https://www.neue-verpackung.de/assets/images/0/21-07-01%20Capri-Sun%20Orange%20mit%20Papierhalm-7d642310.jpg", addOns: [] },
    { name: "Jägermeister", price: 2.00, quantity: 0, color: "#FAD6FF", imgUrl: "https://cdn02.plentymarkets.com/t4l5octwuee2/item/images/888095/full/4067700026668-Jaegermeister-Kraeuterlikoer-3000ml.jpg", addOns: [] },
    { name: "Feigling", price: 2.00, quantity: 0, color: "#D1D1FF", imgUrl: "https://www.getraenke-handel.com/images/product_images/popup_images/Kleiner-Feigling-2-cl.jpg", addOns: [] },
    { name: "Flimm", price: 2.00, quantity: 0, color: "#FFD1C1", imgUrl: "https://www.rheinspirits.com/wp-content/uploads/2020/03/Flimm-Waldmeister-07L-Flasche-K%C3%B6lner-Lik%C3%B6r-Waldmeisterlik%C3%B6r-kaufen-Rheinspirits-K%C3%B6lner-Spirituosen.jpg", addOns: [] },
    { name: "Bärbel", price: 2.00, quantity: 0, color: "#D1FFF5", imgUrl: "https://www.rheinspirits.com/wp-content/uploads/2020/04/Flimm-B%C3%A4rbelchen-Lik%C3%B6r-K%C3%B6ln-Rheinspirits-K%C3%B6lner-Spirituosen.jpg", addOns: [] },
    { name: "Aperol Spritz", price: 6.50, quantity: 0, color: "#FFE5B4", imgUrl: "https://spirituosenworld.de/images/cocktails/aperol-spritz-longdrink-2019.jpg", addOns: [] },
    /* ---------- Speisen ---------- */
    { name: "Pommes",                price: 3.50, quantity: 0, color: "#FFD700", imgUrl: "https://www.citynews-koeln.de/wp-content/uploads/2016/03/754980_original_R_K_B_by_Tim-Reckmann_pixelio.de_.jpg",     addOns: [{ name: "Ketchup", price: 0.00, quantity: 0, color:  "#e86b6b"},{ name: "Mayo",  price: 0.00, quantity: 0, color: "#F0E1B8" },{ name: "Senf",  price: 0.00, quantity: 0,  color: "#FFF0B2" }] },
    { name: "Currysauce",            price: 0.50, quantity: 0, color: "#FF8C00", imgUrl: "https://nicostanitzok.de/wp-content/uploads/2023/01/currywurst_rezept_currysauce_currysosse_selber_machen-2.jpg", addOns: [{ name: "Ketchup", price: 0.00, quantity: 0, color:  "#e86b6b"},{ name: "Mayo",  price: 0.00, quantity: 0, color: "#F0E1B8" },{ name: "Senf",  price: 0.00, quantity: 0,  color: "#FFF0B2" }] },
    { name: "Bratwurst im Brötchen", price: 3.50, quantity: 0, color: "#8B4513", imgUrl: "https://t4.ftcdn.net/jpg/00/62/49/51/360_F_62495158_ZxAaidtgVGqOvEQK5UWdu6nY8NoWPZPo.jpg", addOns: [{ name: "Ketchup", price: 0.00, quantity: 0, color:  "#e86b6b"},{ name: "Mayo",  price: 0.00, quantity: 0, color: "#F0E1B8" },{ name: "Senf",  price: 0.00, quantity: 0,  color: "#FFF0B2" }] },
    { name: "Krakauer im Brötchen",  price: 4.50, quantity: 0, color: "#800000", imgUrl: "https://www.bigtrailie.co.uk/index.php?media/krakauer-im-broetchen.70/full", addOns: [{ name: "Ketchup", price: 0.00, quantity: 0, color:  "#e86b6b"},{ name: "Mayo",  price: 0.00, quantity: 0, color: "#F0E1B8" },{ name: "Senf",  price: 0.00, quantity: 0,  color: "#FFF0B2" }] },
    { name: "Bratwurst mit Fritten", price: 6.50, quantity: 0, color: "#B5651D", imgUrl: "https://live.staticflickr.com/4359/35616258953_d8b4594b5b_b.jpg", addOns: [{ name: "Ketchup", price: 0.00, quantity: 0, color:  "#e86b6b"},{ name: "Mayo",  price: 0.00, quantity: 0, color: "#F0E1B8" },{ name: "Senf",  price: 0.00, quantity: 0,  color: "#FFF0B2" }] },
    { name: "Currywurst mit Fritten",price: 7.00, quantity: 0, color: "#FF4500", imgUrl: "https://d569htemax5yg.cloudfront.net/catalog/product/p/2/p2g5533_3.jpg", addOns: [{ name: "Ketchup", price: 0.00, quantity: 0, color:  "#e86b6b"},{ name: "Mayo",  price: 0.00, quantity: 0, color: "#F0E1B8" },{ name: "Senf",  price: 0.00, quantity: 0,  color: "#FFF0B2" }] },
    { name: "Krakauer mit Fritten",  price: 7.00, quantity: 0, color: "#A52A2A", imgUrl: "https://www.fokus-fleisch.de/assets/uploads/images/_1280xAUTO_crop_center-center_none/Currywurst_web_xs.jpeg", addOns: [{ name: "Ketchup", price: 0.00, quantity: 0, color:  "#e86b6b"},{ name: "Mayo",  price: 0.00, quantity: 0, color: "#F0E1B8" },{ name: "Senf",  price: 0.00, quantity: 0,  color: "#FFF0B2" }] },
    /* ---------- Eis ---------- */
    { name: "Cornetto Erdbeere/Schoko", price: 1.5, quantity: 0, color: "#FFF4B1", imgUrl: "https://assets.unileversolutions.com/v1/90238095.png", addOns: [] },
    { name: "Big Sandwich", price: 2.0, quantity: 0, color: "#D4FFB2", imgUrl: "https://laserstar.rocks/media/32/84/f3/1636544061/31016232_big-sandwich.jpg?ts=1647526171", addOns: [] },
    { name: "Kaktus", price: 1.0, quantity: 0, color: "#FFEAB0", imgUrl: "https://encrypted-tbn1.gstatic.com/shopping?q=tbn:ANd9GcST9GDiNe5HScZw-UHnaVPKC6CyBwh0tmxkPnJArBrt15g0_4Qk0aNrh4lE3BW6YUr24O18yPHQwSQKsbUHErHCF6v6VwSEUw", addOns: [] },
    { name: "BumBum", price: 2.0, quantity: 0, color: "#D4F8FF", imgUrl: "https://www.froneri-schoeller.de/images/default-source/produkte/31024921_schoeller-bum-bum.jpg?sfvrsn=eec4eaf8_0", addOns: [] },
    { name: "Calippo", price: 2.0, quantity: 0, color: "#FFEFD0", imgUrl: "https://onkelseis.de/media/image/product/313/md/langnese-calippo-lime.jpg", addOns: [] }
  ]; 

  // Kategorien zuweisen
  const eisNames = new Set(["Cornetto Erdbeere/Schoko","Big Sandwich","Kaktus","BumBum","Calippo"]);
  const speisenNames = new Set(["Pommes","Currysauce","Bratwurst im Brötchen","Krakauer im Brötchen","Bratwurst mit Fritten","Currywurst mit Fritten","Krakauer mit Fritten"]);
  drinks.forEach(d=>{ if(eisNames.has(d.name)) d.category='Eis'; else if(speisenNames.has(d.name)) d.category='Speisen'; else d.category='Getränke'; });

  let preparedStates = {};

  const mainContent     = document.getElementById('mainContent');
  const drinkContainer  = document.getElementById('drinkContainer');
  const summarySection  = document.getElementById('summarySection');
  const summaryListEl   = document.getElementById('summaryList');
  const summaryContent  = document.getElementById('summaryContent');
  const grandTotalEl    = document.getElementById('grandTotal');
  const grandTotalMini  = document.getElementById('grandTotalMini');
  const resetAllBtn     = document.getElementById('resetAllButton');
  const cashGivenInput  = document.getElementById('cashGiven');
  const changeDisplayEl = document.getElementById('changeDisplay');
  const summaryToggle   = document.getElementById('summaryToggle');
  const categoryBar    = document.getElementById('categoryBar');
  const resetAllBtnHeader = document.getElementById('resetAllButtonHeader');
  const COMPACT_KEY = 'compactMode';
  if (localStorage.getItem(COMPACT_KEY) === '1') { document.body.classList.add('compact'); }
  function setCompact(on){
    document.body.classList.toggle('compact', !!on);
    localStorage.setItem(COMPACT_KEY, document.body.classList.contains('compact') ? '1' : '0');
    adjustLayout();
  }

  let tileElements = [];

  // Hilfsfunktionen: Kontrastfarbe basierend auf Hintergrund
  function hexToRgb(hex){
    if(!hex) return {r:255,g:255,b:255};
    let c = hex.replace('#','');
    if(c.length===3){ c = c.split('').map(x=>x+x).join(''); }
    const num = parseInt(c,16);
    return { r:(num>>16)&255, g:(num>>8)&255, b:num&255 };
  }
  function relativeLuminance(r,g,b){
    const srgb = [r,g,b].map(v=>{ v/=255; return v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055,2.4); });
    return 0.2126*srgb[0] + 0.7152*srgb[1] + 0.0722*srgb[2];
  }
  function getTextColor(hex){
    const {r,g,b} = hexToRgb(hex||'#ffffff');
    const L = relativeLuminance(r,g,b);
    const contrastBlack = (L + 0.05) / 0.05; // schwarz L=0
    const contrastWhite = 1.05 / (L + 0.05); // weiß L=1
    return (contrastWhite > contrastBlack) ? '#fff' : '#111';
  }

  let selectedCategory = 'Alle';
  function buildCategoryBar(){
    const categories = ['Alle', ...Array.from(new Set(drinks.map(d=>d.category)))];
    categoryBar.innerHTML = '';
    categories.forEach(cat=>{
      const btn = document.createElement('button');
      btn.type='button'; btn.className='category-btn'; btn.textContent=cat;
      btn.setAttribute('aria-pressed', cat===selectedCategory ? 'true' : 'false');
      btn.addEventListener('click', ()=>{
        selectedCategory = cat;
        categoryBar.querySelectorAll('.category-btn').forEach(b=> b.setAttribute('aria-pressed', b.textContent===selectedCategory ? 'true' : 'false'));
        applyCategoryFilter();
      });
      categoryBar.appendChild(btn);
    });
  }
  function applyCategoryFilter(){
    tileElements.forEach(({drink, tile})=>{
      const show = (selectedCategory==='Alle') || (drink.category===selectedCategory);
      tile.style.display = show ? '' : 'none';
    });
    adjustLayout();
  }
  function buildDensityToggle(){
    if(!categoryBar) return;
    const old = document.getElementById('densityToggle');
    if(old) old.remove();
    const densityBtn = document.createElement('button');
    densityBtn.id = 'densityToggle';
    densityBtn.type='button';
    densityBtn.className='category-btn density-toggle';
    const setLabel = ()=>{ densityBtn.textContent = document.body.classList.contains('compact') ? 'Kompakt: an' : 'Kompakt: aus'; };
    setLabel();
    densityBtn.addEventListener('click', ()=>{ setCompact(!document.body.classList.contains('compact')); setLabel(); });
    categoryBar.appendChild(densityBtn);
  }

  function initializeTiles(){
    drinks.forEach((drink) => {
      const tile = document.createElement('div');
      tile.classList.add('drink-tile');
      tile.style.borderColor = drink.color;
      tile.setAttribute('role','button');
      tile.setAttribute('aria-label', `${drink.name} hinzufügen`);
      tile.tabIndex = 0;

      const media = document.createElement('div'); media.classList.add('tile-media');
      const img = document.createElement('img');
      img.src = drink.imgUrl; img.alt = drink.name; img.loading = 'lazy'; img.decoding = 'async';
      img.onerror = () => { img.style.display = 'none'; };
      media.appendChild(img);
      tile.appendChild(media);

      const title = document.createElement('h2');
      title.textContent = drink.name; tile.appendChild(title);

      const priceInfo = document.createElement('p'); priceInfo.classList.add('price'); tile.appendChild(priceInfo);
      const quantityInfo = document.createElement('p'); quantityInfo.classList.add('quantity-display'); tile.appendChild(quantityInfo);
      const quantityBadge = document.createElement('span'); quantityBadge.classList.add('quantity-badge'); tile.appendChild(quantityBadge);

      const controls = document.createElement('div'); controls.classList.add('quantity-controls'); tile.appendChild(controls);

      const zeroBtn = document.createElement('button'); zeroBtn.textContent = '0';
      zeroBtn.addEventListener('click', (e)=>{ e.stopPropagation(); drink.quantity = 0; if(drink.addOns){ drink.addOns.forEach(a=>a.quantity=0);} updateView(); });
      controls.appendChild(zeroBtn);

      const minusBtn = document.createElement('button'); minusBtn.textContent='-1';
      minusBtn.addEventListener('click', (e)=>{ e.stopPropagation(); if(drink.quantity>0){ drink.quantity--; updateView(); }});
      controls.appendChild(minusBtn);

      const plus5Btn = document.createElement('button'); plus5Btn.textContent = '+5';
      plus5Btn.addEventListener('click', (e)=>{ e.stopPropagation(); drink.quantity+=5; updateView(); });
      controls.appendChild(plus5Btn);

      // Tap/Klick auf die Kachel => +1
      const inc = ()=>{ drink.quantity++; updateView(); if (navigator.vibrate) navigator.vibrate(10); };
      tile.addEventListener('click', inc);
      tile.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); inc(); }});

      // Add-ons
      const addonElements = [];
      if (drink.addOns && drink.addOns.length){
        const addonsContainer = document.createElement('div'); addonsContainer.classList.add('addons-container'); tile.appendChild(addonsContainer);
        drink.addOns.forEach((addon)=>{
          const addonTile = document.createElement('div'); addonTile.classList.add('addon-tile'); addonTile.style.borderColor = addon.color || '#999';
          addonTile.addEventListener('click', (e)=>{ e.stopPropagation(); addon.quantity++; updateView(); if (navigator.vibrate) navigator.vibrate(8); });

          const addonTitle = document.createElement('h3'); addonTile.appendChild(addonTitle);
          const addonPrice = document.createElement('p'); addonTile.appendChild(addonPrice);
          const addonQuantity = document.createElement('p'); addonTile.appendChild(addonQuantity);

          const addonControls = document.createElement('div'); addonControls.classList.add('addon-controls'); addonTile.appendChild(addonControls);

          const addonZeroBtn = document.createElement('button'); addonZeroBtn.textContent='0';
          addonZeroBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); addon.quantity=0; updateView(); }); addonControls.appendChild(addonZeroBtn);

          const addonMinusBtn = document.createElement('button'); addonMinusBtn.textContent='-1';
          addonMinusBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); if(addon.quantity>0){ addon.quantity--; updateView(); }}); addonControls.appendChild(addonMinusBtn);

          const alignBtn = document.createElement('button'); alignBtn.textContent='='; alignBtn.title='An Hauptgetränk angleichen';
          alignBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); addon.quantity = drink.quantity; updateView(); }); addonControls.appendChild(alignBtn);

          addonElements.push({ addon, addonTile, addonTitle, addonPrice, addonQuantity });
          addonsContainer.appendChild(addonTile);
        });
      }

      drinkContainer.appendChild(tile);
      tileElements.push({ drink, tile, priceInfo, quantityInfo, quantityBadge, addonElements });
    });
  }

  function updateView(){
    tileElements.forEach(el=>{
      const { drink, tile, priceInfo, quantityInfo, quantityBadge, addonElements } = el;
      priceInfo.textContent = (drink.price < 0 ? drink.price.toFixed(2)+" € (Rückgabe)" : drink.price.toFixed(2)+" €").replace('.', ',');
      quantityInfo.textContent = "Menge: " + drink.quantity;

      // Badge im Kompaktmodus
      if (quantityBadge){
        if (drink.quantity > 0){
          quantityBadge.textContent = String(drink.quantity);
          quantityBadge.style.display = 'inline-flex';
          const tc = getTextColor(drink.color);
          quantityBadge.style.color = (tc === '#fff') ? '#fff' : '#111';
          quantityBadge.style.background = (tc === '#fff') ? 'rgba(0,0,0,.35)' : 'rgba(255,255,255,.65)';
          quantityBadge.style.border = '1px solid rgba(0,0,0,.15)';
        } else {
          quantityBadge.style.display = 'none';
        }
      }

      tile.style.borderColor = drink.color;
      if(drink.quantity>0){ tile.classList.add('active'); tile.style.backgroundColor = drink.color;
        tile.style.color = getTextColor(drink.color); }
      else{ tile.classList.remove('active'); tile.style.backgroundColor = '#fff';
        tile.style.color = '#111'; }

      addonElements.forEach(ae=>{
        const { addon, addonTile, addonTitle, addonPrice, addonQuantity } = ae;
        addonTitle.textContent = addon.name;
        addonPrice.textContent = (addon.price !== 0 ? addon.price.toFixed(2)+" €" : "–").replace('.', ',');
        addonQuantity.textContent = "x " + addon.quantity;
        addonTile.style.borderColor = addon.color || '#999';
        addonTile.style.backgroundColor = addon.quantity>0 ? (addon.color || '#eee') : '#fff';
        addonTile.style.color = addon.quantity>0 ? getTextColor(addon.color || '#eee') : '#111';
      });
    });
    updateSummary();
  }

  function updateSummary(){
    let rows = []; let total = 0;
    drinks.forEach(drink=>{
      let lineTotal = drink.quantity * drink.price; let addOnSum = 0; let addOnRows=[];
      if(drink.addOns){
        drink.addOns.forEach(addon=>{
          if(addon.quantity!==0){
            let addonLineTotal = addon.quantity * addon.price; addOnSum += addonLineTotal;
            addOnRows.push({ name: '→ ' + addon.name, quantity: addon.quantity, price: addon.price, total: addonLineTotal, color: drink.color, rowID: 'addon-'+drink.name+'::'+addon.name });
          }
        });
      }
      if(drink.quantity!==0 || addOnSum!==0){
        rows.push({ name: drink.name, quantity: drink.quantity, price: drink.price, total: lineTotal, color: drink.color, rowID: 'main-'+drink.name });
        rows.push(...addOnRows);
      }
      total += lineTotal + addOnSum;
    });
    buildSummaryList(rows);
    const totalText = ("Summe: " + total.toFixed(2).replace('.', ',') + " €");
    grandTotalEl.textContent = totalText;
    grandTotalMini.textContent = total.toFixed(2).replace('.', ',') + ' €';
    calculateChange(total);
    adjustLayout();
  }

  function buildSummaryList(rows){
    if(rows.length===0){ summaryListEl.innerHTML = '<p style="padding:8px 10px;">Keine Artikel ausgewählt.</p>'; return; }
    let html = `
      <table class="summary-table" aria-label="Bestellübersicht">
        <thead>
          <tr>
            <th>Fertig?</th>
            <th>Artikel</th>
            <th>Menge</th>
            <th>Einzelpreis</th>
            <th>Gesamt</th>
          </tr>
        </thead>
        <tbody>
    `;
    rows.forEach(r=>{
      let singlePrice = (r.price!==0) ? r.price.toFixed(2).replace('.', ',') + ' €' : '–';
      let totalPrice  = r.total.toFixed(2).replace('.', ',') + ' €';
      let isChecked   = preparedStates[r.rowID] === true ? 'checked' : '';
      html += `
        <tr data-rowid="${r.rowID}" style="background-color:${r.color}; color:${r.textColor || getTextColor(r.color)};">
          <td><input type="checkbox" data-rowid="${r.rowID}" ${isChecked} /></td>
          <td>${r.name}</td>
          <td>${r.quantity}</td>
          <td>${singlePrice}</td>
          <td>${totalPrice}</td>
        </tr>
      `;
    });
    html += '</tbody></table>';
    summaryListEl.innerHTML = html;

    summaryListEl.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
      chk.addEventListener('change', (e)=>{ let rowID = e.target.dataset.rowid; preparedStates[rowID] = e.target.checked; });
    });
  }

  function calculateChange(total){
    let cash = parseFloat((cashGivenInput.value||'').replace(',', '.'));
    if(isNaN(cash)){ changeDisplayEl.textContent = ''; return; }
    let diff = cash - total;
    if(diff>=0){ changeDisplayEl.textContent = 'Rückgeld: ' + diff.toFixed(2).replace('.', ',') + ' €'; }
    else{ changeDisplayEl.textContent = 'Fehlbetrag: ' + Math.abs(diff).toFixed(2).replace('.', ',') + ' €'; }
  }

  function adjustLayout(){
    // Abstand unten, damit die Kacheln nicht unter das Bottom‑Sheet laufen
    const height = summarySection.classList.contains('collapsed') ? summarySection.querySelector('.summary-header').offsetHeight : summarySection.offsetHeight;
    mainContent.style.paddingBottom = (height + 16) + 'px';
  }

  function resetAll(){
    drinks.forEach(drink=>{ drink.quantity=0; if(drink.addOns){ drink.addOns.forEach(a=>a.quantity=0);} });
    cashGivenInput.value = ''; preparedStates = {}; updateView();
  }

  function ensureResetButtonInContent(){
    const sc = document.getElementById('summaryContent');
    if (sc && !document.getElementById('resetAllButton')){
      const btn = document.createElement('button');
      btn.className = 'reset-all-btn';
      btn.id = 'resetAllButton';
      btn.textContent = 'Gesamte Bestellung auf 0';
      sc.appendChild(btn);
      btn.addEventListener('click', resetAll);
    }
  }

  function sanitizeSummary(){
    // Nur eine Summary behalten
    const summaries = document.querySelectorAll('.summary');
    summaries.forEach((el, idx)=>{ if(idx>0) el.remove(); });
    // Nur Toggle im Header erlauben
    document.querySelectorAll('.summary-toggle').forEach(el=>{ if(!el.closest('.summary-header')) el.remove(); });
    // Nur Mini-Summe im Header erlauben
    document.querySelectorAll('#grandTotalMini').forEach(el=>{ if(!el.closest('.summary-header')) el.remove(); });
  }

  function setCollapsed(collapsed){
    summarySection.classList.toggle('collapsed', !!collapsed);
    summaryToggle.setAttribute('aria-expanded', (!collapsed).toString());
    adjustLayout();
  }

  // Init
  window.addEventListener('load', ()=>{
    // Grundinitialisierung
    initializeTiles();
    updateView();

    // Filter-/UI-Bars
    buildCategoryBar();
    buildDensityToggle();
    applyCategoryFilter();

    // Header sicher über den Inhalt setzen
    const headerEl = document.querySelector('.summary-header');
    const contentEl = document.getElementById('summaryContent');
    const sectionEl = document.getElementById('summarySection');
    if (sectionEl && headerEl && contentEl && headerEl.nextElementSibling !== contentEl) {
      sectionEl.insertBefore(headerEl, contentEl);
    }

    // Zusätzliche Sicherungen/Buttons
    if (typeof ensureResetButtonInContent === 'function') ensureResetButtonInContent();
    if (typeof sanitizeSummary === 'function') sanitizeSummary();

    // Startzustand
    setCollapsed(false);
  });

  if (resetAllBtnHeader) resetAllBtnHeader.addEventListener('click', resetAll);
  if (resetAllBtn)       resetAllBtn.addEventListener('click', resetAll);

  if (cashGivenInput) cashGivenInput.addEventListener('input', ()=>{
    let total = 0; drinks.forEach(d=>{ total += d.quantity * d.price; if(d.addOns){ d.addOns.forEach(a=> total += a.quantity * a.price ); } });
    calculateChange(total);
  });

  if (summaryToggle) summaryToggle.addEventListener('click', ()=>{
    setCollapsed(!summarySection.classList.contains('collapsed'));
  });

  window.addEventListener('resize', adjustLayout);
    // Zeilenklick in der Übersicht: toggelt das Häkchen
  if (summaryListEl) {
    summaryListEl.addEventListener('click', function(e){
      const tr = e.target.closest('tbody tr');
      if (!tr) return;
      if (e.target.closest('input, button, a, label')) return; // Interaktives nicht doppelt toggeln
      const chk = tr.querySelector('input[type="checkbox"]');
      if (!chk) return;
      chk.checked = !chk.checked;
      const rowID = chk.dataset.rowid || tr.dataset.rowid;
      preparedStates[rowID] = chk.checked;
      // Sofort Styles aktualisieren & Change-Event auslösen
      tr.classList.toggle('row-checked', chk.checked);
      chk.dispatchEvent(new Event('change', { bubbles: true }));
    });
  }
  // --- Größeres Häkchen + Zeilen-Rahmen (blau) ---
  function syncRowCheckedStyles(){
    if(!summaryListEl) return;
    summaryListEl.querySelectorAll('tbody tr').forEach(tr=>{
      const chk = tr.querySelector('input[type="checkbox"]');
      if(chk){ tr.classList.toggle('row-checked', chk.checked); }
    });
  }
  // Delegierter Listener: reagiert auf Änderungen an Checkboxen
  if (summaryListEl){
    summaryListEl.addEventListener('change', function(e){
      if(e.target && e.target.matches('input[type="checkbox"]')){
        const tr = e.target.closest('tr');
        if(tr){ tr.classList.toggle('row-checked', e.target.checked); }
      }
    });
    // Beobachte DOM-Änderungen (nach rebuild der Tabelle)
    const obs = new MutationObserver(()=>{ syncRowCheckedStyles(); });
    obs.observe(summaryListEl, { childList: true });
  }
  // Erste Synchronisierung
  syncRowCheckedStyles();
</script>
</body>
</html>
